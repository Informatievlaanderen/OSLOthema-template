name: Check diff between template and current state
on: [push]

jobs:
  generate-diff:
    runs-on: ${{ matrix.os }}
    strategy:
      matrix:
        os: [ubuntu-latest]
        node-version:
          - 18.x
    steps:
      - name: Checkout source branch
        uses: actions/checkout@v4
        with:
          repository: Informatievlaanderen/OSLOthema-template
          ref: standaardenregister
          path: source

      - name: Clone other repository
        uses: actions/checkout@v4
        with:
          # Dynamic reference to the active repository so that it works immediately when creating a new thema repo
          # repository: ${{ github.repository }}
          repository: Informatievlaanderen/OSLOthema-voorwaarden-dienstverlening
          ref: standaardenregister
          path:
            target
            # Extra step to debug the file structure
      - name: List file structure of source dir
        shell: bash
        run: |
          ls source
      - name: List file structure of target dir
        shell: bash
        run: |
          ls target
      - name: Create diff
        shell: bash
        run: |
          # fallback needed because diff returns 1 when there are differences which causes the workflow to fail
          git diff --no-index --name-only source target > source/diff.txt || true
      - name: Commit and push diff
        run: |
          cd source
          git config user.name github-actions
          git config user.email github-actions@github.com
          git add diff.txt
          git commit -m "Add diff"
          git push
